# Теоретическая база: Модели следования и анализ устойчивости

## 1. Введение

Модели следования за автомобилем (car-following models) описывают, как водители управляют своими транспортными средствами в зависимости от поведения впереди идущего автомобиля. Эти модели являются ключевым компонентом микроскопического моделирования транспортных потоков и используются для анализа пропускной способности дорог, возникновения заторов и оценки влияния различных стратегий управления движением. Линейный анализ устойчивости позволяет исследовать, как малые возмущения в транспортном потоке (например, резкое торможение одного автомобиля) распространяются и влияют на стабильность движения всей колонны автомобилей.

## 2. Интеллектуальная модель водителя (IDM)

Интеллектуальная модель водителя (IDM), предложенная Трейбером, Хеннеке и Хелбингом (2000), является популярной моделью следования, стремящейся реалистично описать поведение водителя.

### 2.1. Модель IDM (Intelligent Driver Model)

Уравнение IDM:
\[
dv/dt = a [1 - (v/v_0)^\delta - (s^*(v, \Delta v)/s)^2]
\]
где:
- \( v \) - текущая скорость автомобиля.
- \( dv/dt \) - ускорение автомобиля.
- \( a \) - максимальное ускорение. **Физический смысл**: Это максимальное ускорение, которое водитель готов применить в идеальных условиях (свободная дорога, нет препятствий). Оно отражает динамические возможности автомобиля и агрессивность водителя.
- \( v_0 \) - желаемая скорость. **Физический смысл**: Скорость, которую водитель стремится поддерживать на свободной дороге. Зависит от ограничений скорости, погодных условий, индивидуальных предпочтений.
- \( \delta \) - показатель экспоненты ускорения. **Физический смысл**: Определяет, насколько резко ускорение уменьшается по мере приближения скорости \( v \) к желаемой скорости \( v_0 \). Типичное значение \( \delta = 4 \) обеспечивает реалистичное поведение.
- \( s \) - текущее расстояние до впереди идущего автомобиля (зазор).
- \( \Delta v = v - v_{lead} \) - относительная скорость с впереди идущим автомобилем (\( v_{lead} \) - скорость лидера).
- \( s^*(v, \Delta v) \) - желаемое динамическое расстояние. **Физический смысл**: Минимальное безопасное расстояние, которое водитель старается поддерживать до впереди идущего автомобиля. Оно зависит от текущей скорости \( v \) и разницы скоростей \( \Delta v \).

Компонент \( (v/v_0)^\delta \) описывает стремление водителя достичь желаемой скорости \( v_0 \) на свободной дороге (когда \( s \to \infty \)).

Компонент \( (s^*(v, \Delta v)/s)^2 \) описывает торможение при приближении к впереди идущему автомобилю. Он становится значительным, когда текущий зазор \( s \) приближается к желаемому динамическому расстоянию \( s^* \). Квадратичная зависимость обеспечивает плавное, но достаточно сильное торможение.

### 2.2. Желаемое динамическое расстояние \( s^* \)

\[
s^*(v, \Delta v) = s_0 + vT + \frac{v \Delta v}{2 \sqrt{ab}}
\]
где:
- \( s_0 \) - минимальный зазор (в стоячем положении). **Физический смысл**: Безопасный зазор до переднего автомобиля, когда оба автомобиля стоят. Учитывает возможные небольшие смещения, ошибки восприятия.
- \( T \) - желаемое время следования (safe time headway). **Физический смысл**: Время, которое водитель хочет иметь в запасе для реакции на изменение скорости переднего автомобиля. \( vT \) – это расстояние, которое автомобиль пройдет за время \( T \) со скоростью \( v \). Этот компонент обеспечивает увеличение безопасной дистанции с ростом скорости.
- \( b \) - комфортное торможение. **Физический смысл**: Ускорение (замедление), которое водитель считает комфортным при торможении. Используется для расчета дополнительного зазора, необходимого для безопасной остановки без резкого торможения, если передний автомобиль внезапно тормозит.
- Динамический член \( \frac{v \Delta v}{2 \sqrt{ab}} \) (Intelligent Driver Model term):
    - **Физический смысл**: Этот член учитывает относительную скорость \( \Delta v \). Если \( \Delta v > 0 \) (догоняем), то \( s^* \) увеличивается, заставляя водителя тормозить активнее. Если \( \Delta v < 0 \) (отстаем), то этот член может даже уменьшить \( s^* \) (если \( v \Delta v \) отрицательно и велико по модулю), позволяя сократить дистанцию. Он моделирует "интеллектуальное" предвидение водителя, который регулирует дистанцию в зависимости от динамики относительного движения. Множитель \( \frac{v}{2 \sqrt{ab}} \) связывает этот адаптивный зазор со скоростью и параметрами ускорения/торможения, отражая оценку водителем расстояния, необходимого для компенсации разницы скоростей.

### 2.3. Параметры IDM (используемые в `src/eidm_stability_analysis.py`)

*   `v0_desired_speed` ($v_0$): Желаемая скорость (м/с).
*   `T_safe_time_headway` ($T$): Желаемая безопасная временная дистанция (с).
*   `a_max_accel` ($a$): Максимальное комфортное ускорение (м/с²).
*   `b_comfort_decel` ($b$): Комфортное торможение (м/с²).
*   `delta_accel_exponent` ($\delta$): Показатель степени в члене ускорения (безразмерный).
*   `s0_jam_distance` ($s_0$): Минимальный чистый зазор в заторе (м).
*   `l_vehicle_length` ($l$): Длина транспортного средства (м). Используется для пересчета между чистым зазором ($s_{net}$) и полным межцентровым расстоянием ($s_{total} = s_{net} + l$).
*   `s1_gap_param` ($s_1$): Параметр дополнительного зазора, зависящий от скорости (м). В данном анализе и коде обычно принимается равным 0, согласно статье.

## 3. Равновесные состояния

Равновесное состояние в транспортном потоке характеризуется тем, что все автомобили движутся с постоянной скоростью $v_e$ (equilibrium velocity) и поддерживают постоянную дистанцию $s_{e,net}$ (equilibrium net headway), а их ускорение равно нулю ($a_{IDM}=0$). В этом состоянии относительная скорость между соседними автомобилями также равна нулю ($\Delta v = 0$).

### 3.1. Нахождение равновесной скорости $v_e$ для заданной чистой дистанции $s_{e,net}$

Если задан равновесный чистый зазор $s_{e,net}$, то равновесная скорость $v_e$ находится путем решения уравнения $a_{IDM}(s_{e,net}, \Delta v = 0, v_e) = 0$ относительно $v_e$.
Так как $\Delta v = 0$, то $s^*(v_e, 0) = s_0 + v_eT$. Уравнение $a_{IDM}=0$ принимает вид:
$a \left[ 1 - \left( \frac{v_e}{v_0} \right)^{\delta} - \left( \frac{s_0 + v_eT}{s_{e,net}} \right)^2 \right] = 0$
Это нелинейное уравнение относительно $v_e$, которое решается численно в функции `find_equilibrium_velocity`.

### 3.2. Нахождение равновесной чистой дистанции $s_{e,net}$ для заданной скорости $v_e$

Если задана равновесная скорость $v_e$, то соответствующий ей равновесный чистый зазор $s_{e,net}$ находится также из условия $a_{IDM}(s_{e,net}, \Delta v = 0, v_e) = 0$. В этом случае $s_{e,net}$ должен быть равен $s^*(v_e, 0)$:
$s_{e,net} = s_0 + v_eT$.
Это простое выражение, так как водитель при равновесии будет поддерживать желаемый зазор, соответствующий его скорости $v_e$ и отсутствию разницы скоростей. Реализовано в функции `calculate_s_star_for_fixed_v_star`.

### 3.3. Нахождение равновесных состояний ($v_e, s_{e,net}$) для заданного потока $Q$

Поток $Q$ (автомобилей/сек) связан со скоростью $v_e$ (м/с) и полным равновесным межцентровым расстоянием $s_{e,total}$ (м) как $Q = v_e / s_{e,total}$.
Плотность потока $\rho$ (автомобилей/м) равна $1 / s_{e,total}$. Таким образом, $Q = v_e \rho$.
Так как $s_{e,total} = s_{e,net} + l$ (где $l$ - длина автомобиля), то $s_{e,net} = v_e/Q - l$.
Равновесные состояния ($v_e, s_{e,net}$) для заданного потока $Q$ находятся решением системы уравнений:
1.  $a_{IDM}(s_{e,net}, 0, v_e) = 0$ (условие нулевого ускорения)
2.  $s_{e,net} = v_e/Q - l$ (определение потока)
Подстановка второго уравнения в первое (или, что эквивалентно, подстановка $s_{e,net} = s_0 + v_eT$ в $s_{e,net} = v_e/Q - l$) дает нелинейное уравнение относительно $v_e$: $s_0 + v_eT = v_e/Q - l$. Это уравнение может иметь несколько решений для $v_e$ (обычно два или ни одного действительного положительного решения). Это связано с тем, что фундаментальная диаграмма (зависимость $Q$ от плотности $\rho$, или $Q$ от $v_e$) для IDM является немонотонной: она возрастает от нуля до максимального значения (пропускной способности), а затем убывает. Таким образом, для одного и того же значения потока $Q$ (меньшего, чем пропускная способность) может существовать два режима движения: свободный поток (высокая скорость, малая плотность) и плотный, или заторный, поток (низкая скорость, высокая плотность).
Это реализуется в функциях `find_equilibrium_state_for_flow` и `find_all_equilibrium_states_for_flow`.

### 3.2. Множественные состояния равновесия и их физический смысл

Система может иметь несколько состояний равновесия из-за нелинейности функции оптимальной скорости \( V(s) \).
- **Свободный поток**: В этом состоянии автомобили движутся с желаемой скоростью \( v_0 \), и расстояние между ними велико (\( s \gg s^*(v_0, 0) \)). Плотность потока низкая.
- **Синхронизированный поток**: Автомобили движутся с одинаковой скоростью, меньшей \( v_0 \), и поддерживают стабильную дистанцию, определяемую функцией \( V(s) \). Плотность выше, чем в свободном потоке. Это состояние может возникать спонтанно из-за возмущений.
- **Затор (Stop-and-Go)**: В этом состоянии автомобили периодически останавливаются и снова начинают движение. Скорость в среднем очень низкая, а плотность очень высокая. Это крайне нестабильное состояние.

**Причины множественных состояний**:
1.  **Нелинейная реакция водителей**: Реакция водителя (ускорение/торможение) нелинейно зависит от зазора \( s \) и относительной скорости \( \Delta v \). Например, при малых зазорах водители тормозят гораздо интенсивнее.
2.  **Задержка реакции**: Водители реагируют на изменения с некоторой задержкой, что может приводить к перерегулированию и осцилляциям.
3.  **Функция \( V(s) \)**: Сама форма функции оптимальной скорости, которая для IDM неявно задается через \( dv/dt = 0 \) при \( \Delta v = 0 \), может иметь участки с разным наклоном, что соответствует различным режимам движения. В IDM равновесная скорость \( v_e \) при \( \Delta v = 0 \) определяется решением уравнения \( 1 - (v_e/v_0)^\delta - (s_0 + v_e T)/s)^2 = 0 \). Это уравнение может иметь несколько решений для \( v_e \) при заданном \( s \), или, что эквивалентно, для заданного \( v_e \) может существовать несколько \( s \), поддерживающих это равновесие (хотя обычно анализируют \( v_e(s) \)). Это не так очевидно из самой формулы IDM, как для моделей, где \( V(s) \) задана явно, но нелинейность все равно присутствует. Критически важно, что производная \( dV/ds \) (чувствительность к изменению зазора) не постоянна.

Эти множественные состояния объясняют, почему транспортный поток может внезапно переходить от свободного движения к затору без видимых внешних причин, а лишь из-за внутренних флуктуаций.

## 4. Линейный анализ устойчивости

Линейный анализ устойчивости исследует поведение системы в ответ на малые возмущения (флуктуации) от состояния равновесия. Цель – определить, будут ли эти малые возмущения затухать со временем (устойчивое состояние) или нарастать (неустойчивое состояние). Уравнение движения $n$-го автомобиля в потоке можно записать в общем виде:
$\ddot{x}_n = \dot{v}_n = f(s_n, \Delta v_n, v_n)$
где $x_n$ - позиция $n$-го автомобиля, $s_n = x_{n-1} - x_n - l$ - чистый зазор до $(n-1)$-го (лидирующего) автомобиля, $\Delta v_n = v_{n} - v_{n-1}$ - разность скоростей текущего автомобиля и лидера (определение Трейбера).

### 4.1. Малые возмущения

Рассматриваются малые отклонения от равновесного состояния $(s_{e,net}, 0, v_e)$:
$s_n(t) = s_{e,net} + \tilde{s}_n(t)$
$v_n(t) = v_e + \tilde{v}_n(t)$
Тогда $\Delta v_n(t) = (v_e + \tilde{v}_{n}(t)) - (v_e + \tilde{v}_{n-1}(t)) = \tilde{v}_{n}(t) - \tilde{v}_{n-1}(t)$.
Также, из определения $s_n$, имеем $\dot{s}_n(t) = v_{n-1}(t) - v_n(t) = -\Delta v_n(t)$. Следовательно, $\dot{\tilde{s}}_n(t) = -\Delta \tilde{v}_n(t)$.

### 4.2. Линеаризованное уравнение и его производные

Линеаризованное уравнение для возмущения $ y_n(t) = x_n(t) - nL - v_e t \):
\[
\ddot{y}_n(t) + \alpha \dot{y}_n(t) = f_s (\dot{y}_{n-1}(t-\tau) - \dot{y}_n(t-\tau)) + f_v (y_{n-1}(t-\tau) - y_n(t-\tau))
\]
Перепишем его как:
\[
\frac{d^2 y_n(t)}{dt^2} + \left( \frac{\partial F}{\partial v_n} \right)_e \frac{d y_n(t)}{dt} = \left( \frac{\partial F}{\partial s_n} \right)_e (y_{n-1}(t-\tau) - y_n(t-\tau)) + \left( \frac{\partial F}{\partial \Delta v_n} \right)_e \left( \frac{d y_{n-1}(t-\tau)}{dt} - \frac{d y_n(t-\tau)}{dt} \right)
\]
где $ F $ - правая часть уравнения IDM, а производные вычисляются в состоянии равновесия (\( v_n = v_e, s_n = s_e, \Delta v_n = 0 \)).

**Интуитивная интерпретация производных**:

1.  **\( \alpha = -(\frac{\partial F}{\partial v_n})_e \)**: Коэффициент затухания или чувствительность реакции на собственную скорость.
    - **Физический смысл**: Показывает, насколько сильно водитель реагирует (изменяет ускорение) на отклонение его *собственной* скорости от равновесной $ v_e $.
    - В IDM: $ F = a [1 - (v_n/v_0)^\delta - (s^*(v_n, \Delta v_n)/s_n)^2] $.
    - $ \frac{\partial F}{\partial v_n} = -a \delta \frac{v_n^{\delta-1}}{v_0^\delta} - 2a \frac{s^*}{s_n^2} \frac{\partial s^*}{\partial v_n} $.
    - В равновесии (\( \Delta v_n = 0 \)), $ s^*(v_n, 0) = s_0 + v_n T $, тогда $ \frac{\partial s^*}{\partial v_n} = T $.
    - $ (\frac{\partial F}{\partial v_n})_e = -a \delta \frac{v_e^{\delta-1}}{v_0^\delta} - 2a \frac{s_0 + v_e T}{s_e^2} T $.
    - Так как это значение обычно отрицательное (увеличение скорости выше равновесной ведет к отрицательному ускорению), то $ \alpha $ положительно, что способствует затуханию возмущений собственной скорости. Чем больше $ \alpha $, тем быстрее автомобиль возвращается к $ v_e $ после небольшого случайного изменения его скорости.

2.  **$ f_s = (\frac{\partial F}{\partial s_n})_e $**: Чувствительность к изменению зазора.
    - **Физический смысл**: Показывает, насколько сильно водитель реагирует на отклонение зазора $ s_n $ от равновесного $ s_e $.
    - В IDM: $ \frac{\partial F}{\partial s_n} = -2a (s^*)^2 (-2) s_n^{-3} = 2a \frac{(s^*)^2}{s_n^3} $.
    - $ ( \frac{\partial F}{\partial s_n} )_e = 2a \frac{(s_0+v_e T)^2}{s_e^3} $.
    - Это значение всегда положительно. Если зазор $ s_n $ увеличивается (т.е. $ y_{n-1} - y_n $ становится больше), член $ f_s (y_{n-1} - y_n) $ положителен, что приводит к ускорению для сокращения зазора. Если зазор уменьшается, член отрицателен, вызывая торможение.

3.  **$ f_{\Delta v} = (\frac{\partial F}{\partial \Delta v_n})_e $**: Чувствительность к изменению относительной скорости.
    - **Физический смысл**: Показывает, насколько сильно водитель реагирует на появление относительной скорости $ \Delta v_n $ (т.е. на то, что его скорость отличается от скорости лидера, даже если зазор $ s_e $ сохраняется).
    - В IDM: $ \frac{\partial F}{\partial \Delta v_n} = -2a \frac{s^*}{s_n^2} \frac{\partial s^*}{\partial \Delta v_n} $.
    - $ s^*(v_n, \Delta v_n) = s_0 + v_n T + \frac{v_n \Delta v_n}{2 \sqrt{ab}} $, поэтому $ \frac{\partial s^*}{\partial \Delta v_n} = \frac{v_n}{2 \sqrt{ab}} $.
    - $ ( \frac{\partial F}{\partial \Delta v_n} )_e = -2a \frac{s_0+v_e T}{s_e^2} \frac{v_e}{2 \sqrt{ab}} = -a \frac{(s_0+v_e T)v_e}{s_e^2 \sqrt{ab}} $.
    - Это значение обычно отрицательно. Если $ \Delta v_n > 0 $ (догоняем лидера, $ \dot{y}_{n-1} - \dot{y}_n < 0 $ в терминах производных возмущений), то производная отрицательна, и член $ (\frac{\partial F}{\partial \Delta v_n})_e (\dot{y}_{n-1} - \dot{y}_n) $ становится положительным, что способствует ускорению (нелогично, нужно проверить знаки).
    Давайте уточним: $ \Delta v_n = v_n - v_{n-1} $. В терминах возмущений: $ v_n = v_e + \dot{y}_n(t) $, $ v_{n-1} = v_e + \dot{y}_{n-1}(t) $. Тогда $ \Delta v_n = \dot{y}_n(t) - \dot{y}_{n-1}(t) $.
    В исходной статье используется $ \Delta v = v_{follower} - v_{leader} $. Тогда, если $ n $ - это follower, а $ n-1 $ - это leader, то $ \Delta v_n = v_n - v_{n-1} $.
    Тогда правая часть уравнения должна быть $ (\frac{\partial F}{\partial \Delta v_n})_e (\dot{y}_n(t-\tau) - \dot{y}_{n-1}(t-\tau)) $.
    Если $ (\frac{\partial F}{\partial \Delta v_n})_e $ отрицательно:
        - Когда $ \dot{y}_n > \dot{y}_{n-1} $ (догоняем быстрее, чем равновесное состояние), $ \Delta v_n > 0 $, член $ (\frac{\partial F}{\partial \Delta v_n})_e \Delta v_n $ отрицателен -> торможение. Это правильно.
    Значит, $ f_{\Delta v} $ должно быть со знаком, соответствующим реакции на $ \Delta v_n = v_n - v_{n-1} $. Если $ f_{\Delta v} $ домножается на $ \dot{y}_{n-1} - \dot{y}_n $, то для получения правильного знака реакции, сам коэффициент $ f_{\Delta v} $ может быть положительным.
    Давайте придерживаться определения из статьи: $ f_v = (\frac{\partial F}{\partial \Delta v_n})_e $, где $ \Delta v_n $ - это скорость текущего авто минус скорость лидера. И в линеаризованном уравнении член выглядит как $ f_v (\dot{y}_{n-1} - \dot{y}_n) $.
    Тогда $ ( \frac{\partial F}{\partial \Delta v_n} )_e = -a \frac{(s_0+v_e T)v_e}{s_e^2 \sqrt{ab}} $. Пусть это $ C < 0 $.
    Тогда член в уравнении: $ C \cdot (\dot{y}_{n-1}(t-\tau) - \dot{y}_n(t-\tau)) $.
    Если $ n $-ый догоняет ($ v_n > v_{n-1} $), то $ \dot{y}_n > \dot{y}_{n-1} $, тогда $ \dot{y}_{n-1} - \dot{y}_n < 0 $. Произведение $ C \cdot (\text{отриц.}) $ будет положительным (ускорение). Это неправильно.
    **Коррекция**: В IDM, если $ \Delta v = v_{self} - v_{lead} $ положительно (догоняем), то член $ (s^*/s)^2 $ увеличивается из-за $ \Delta v $ в $ s^* $, что ведет к уменьшению ускорения (торможению). Значит, $ \frac{\partial F}{\partial \Delta v} $ должно быть отрицательным.
    Значит, $ f_{\Delta v} = (\frac{\partial F}{\partial \Delta v_n})_e = -a \frac{(s_0+v_e T)v_e}{s_e^2 \sqrt{ab}} $ - это коэффициент.
    Тогда в уравнении используется $ (\frac{\partial F}{\partial \Delta v_n})_e (\Delta \dot{y}_{n}) $, где $ \Delta \dot{y}_{n} = \dot{y}_n(t-\tau) - \dot{y}_{n-1}(t-\tau) $.
    Если $ \dot{y}_n > \dot{y}_{n-1} $ (догоняем), то $ \Delta \dot{y}_n > 0 $. Тогда $ (\frac{\partial F}{\partial \Delta v_n})_e \Delta \dot{y}_n $ будет отрицательным (торможение). Это верно.
    Поэтому, если в уравнении стоит $ f_v (\dot{y}_{n-1} - \dot{y}_n) $, то $ f_v = -(\frac{\partial F}{\partial \Delta v_n})_e = a \frac{(s_0+v_e T)v_e}{s_e^2 \sqrt{ab}} $. Этот $ f_v $ будет положительным. Он показывает, насколько сильно водитель реагирует, чтобы *уменьшить* разницу скоростей.

В совокупности эти производные определяют, как малое возмущение (например, небольшое изменение скорости или положения одного автомобиля) будет распространяться по колонне автомобилей.

## 5. Устойчивость взвода (Platoon Stability / Local Stability)

Устойчивость взвода (или локальная устойчивость) описывает, затухнут ли со временем флуктуации скорости и дистанции в *конечном* взводе автомобилей после некоторого начального возмущения (например, если первый автомобиль во взводе внезапно меняет скорость), при условии, что самый первый (головной) автомобиль взвода после этого движется с постоянной скоростью. Это свойство относится к реакции отдельного автомобиля на своего непосредственного лидера и не рассматривает распространение волны возмущений по всей длине бесконечной цепочки.

Характеристическое уравнение для анализа устойчивости взвода, описывающее эволюцию малых возмущений (Ур. 16 в статье Трейбера, где $ f_{\Delta v} $ положительна из-за их определения $ \Delta v = v_{leader} - v_{follower} $):
$\lambda_{plat}^2 + (f_{\Delta v} - f_v) \lambda_{plat} + f_s = 0$
Здесь $ f_{\Delta v} $ соответствует производной $ \frac{\partial a_{IDM}}{\partial (v_{leader} - v_{follower})} $. Если мы используем нашу $ f_{\Delta v}^* = \frac{\partial a_{IDM}}{\partial (v_{follower} - v_{leader})} = -f_{\Delta v} $, то уравнение примет вид:
$\lambda_{plat}^2 + (-f_{\Delta v}^* - f_v) \lambda_{plat} + f_s = 0$

Взвод считается устойчивым, если действительные части обоих корней $ \lambda_{plat} $ характеристического уравнения отрицательны (т.е. $ \text{Re}(\lambda_{plat}) < 0 $). Это означает, что любые малые отклонения от равновесия будут экспоненциально затухать со временем. Согласно критериям Рауса-Гурвица для квадратичного уравнения $ \lambda^2 + A\lambda + B = 0 $, это эквивалентно тому, что все коэффициенты уравнения положительны: $ A > 0 $ и $ B > 0 $.
В нашем случае (используя $ f_{\Delta v}^* < 0 $ и $ f_v < 0 $):
1.  $ B = f_s > 0 $ (из условий рационального вождения).
2.  $ A = (-f_{\Delta v}^* - f_v) > 0 $. Так как $ f_v < 0 $, то $-f_v > 0 $. Если $ f_{\Delta v}^* \le 0 $ (рациональное вождение), то $-f_{\Delta v}^* \ge 0 $. Следовательно, $ A $ обычно положительно.

Таким образом, если условия рационального вождения выполнены, модель IDM, как правило, является локально (взводно) устойчивой. Анализ проводится в функции `analyze_platoon_stability`.

## 6. Устойчивость потока/цепочки (String Stability / Asymptotic Stability)

Устойчивость потока (или струнная устойчивость) характеризует, как возмущения распространяются вверх по *бесконечной* цепочке автомобилей (т.е. от автомобиля $ n $ к $ n+1 $, $ n+2 $, ...). Поток считается устойчивым, если амплитуда возмущений затухает при распространении от автомобиля к автомобилю вверх по течению. Если амплитуда нарастает ($ \text{амплитуда у авто } n+1 > \text{амплитуда у авто } n $), поток неустойчив. Это может приводить к образованию спонтанных заторов и волн "stop-and-go", даже если локальная (взводная) устойчивость соблюдается. Ключевым фактором здесь является запаздывание реакции, обусловленное необходимостью сначала воспринять изменение в движении лидера, а затем отреагировать, что происходит за время, связанное с межмашинной дистанцией.

### 6.1. Критерий на основе $ \lambda_2 $ (или K в коде)

Один из подходов к анализу устойчивости потока для длинноволновых возмущений (малые волновые числа $ k $, т.е. возмущения, растянутые на большие расстояния) заключается в исследовании знака коэффициента $ \lambda_2 $ (Ур. 20 в статье Трейбера) в разложении действительной части инкремента $ \text{Re}(\lambda(k)) $ по волновому числу $ k $ для $ k \to 0 $. Уравнение из статьи:
$ \lambda_2 = \frac{f_s}{f_v^3} \left( \frac{f_v^2}{2} - f_{\Delta v} f_v - f_s \right) $
(Здесь $ f_{\Delta v} $ соответствует определению $ \frac{\partial a_{IDM}}{\partial (v_{follower} - v_{leader})} $, т.е. $ f_{\Delta v} < 0 $ для рационального поведения).

При выполнении условий рационального вождения ($ f_s > 0, f_v < 0 $), множитель $ f_s/f_v^3 $ всегда отрицателен.
Для устойчивости потока необходимо, чтобы $ \text{Re}(\lambda(k)) $ было отрицательным для всех $ k $, включая малые $ k $. Для длинноволновых возмущений, $ \text{Re}(\lambda(k)) \approx \lambda_2 k^2 $. Чтобы это было отрицательным (так как $ k^2>0 $), требуется $ \lambda_2 < 0 $. Это, в свою очередь, означает, что выражение в скобках должно быть **положительным**:
$ K = \frac{f_v^2}{2} - f_{\Delta v} f_v - f_s > 0 $
Этот критерий $ K $ используется в функции `analyze_string_stability`.
Интуитивно, $ K>0 $ означает, что стабилизирующие эффекты (быстрая реакция на собственную скорость, выраженная через $ f_v^2/2 $, и реакция на слишком малый зазор, $-f_s $) превосходят дестабилизирующие эффекты, связанные с реакцией на относительную скорость с учетом запаздывания в передаче информации по цепочке (член $-f_{\Delta v}f_v $). Если реакция на относительную скорость $ \Delta v $ (которая включает информацию от предыдущего автомобиля) слишком сильная или запаздывание слишком велико, это может привести к нарастанию возмущений.

### 6.2. Общий анализ через $ \lambda(k) $

Более общий метод анализа устойчивости потока заключается в нахождении собственных значений (инкрементов) $ \lambda $ характеристического уравнения линеаризованной системы для различных волновых чисел $ k $. Волновое число $ k $ обратно пропорционально длине волны возмущения $ L_{wave} $ ($ k = 2\pi / L_{wave} $). Малые $ k $ соответствуют длинноволновым возмущениям, большие $ k $ - коротковолновым.
Характеристическое уравнение для $ \lambda(k) $ (аналог Ур. 18 в статье Трейбера, где $ f_{\Delta v} $ определена для $ \Delta v = v_{leader} - v_{follower} $ и положительна):
$ \lambda^2 + \lambda [f_{\Delta v} - f_v - f_{\Delta v} e^{-i k s_{e,total} }] + [f_s (1 - e^{-i k s_{e,total} })] = 0 $
Здесь $ s_{e,total} = s_{e,net} + l $ – полное равновесное межцентровое расстояние. Член $ e^{-i k s_{e,total}} $ представляет собой фазовый сдвиг, возникающий из-за того, что $ n $-й автомобиль реагирует на состояние $ (n-1) $-го автомобиля, которое было в прошлом из-за конечного времени распространения информации (связанного с $ s_{e,total} $). Это запаздывание является основной причиной струнной неустойчивости.

Поток считается асимптотически (струнно) устойчивым, если максимальная действительная часть корней $ \lambda(k) $ отрицательна для всех $ k \in (0, \pi/s_{e,total}] $ (диапазон волновых чисел, имеющих физический смысл). То есть, $ \max_k (\text{Re}(\lambda(k))) < 0 $. Если же $ \max_k (\text{Re}(\lambda(k))) > 0 $ для какого-либо $ k $, то поток неустойчив, и возмущения с соответствующей длиной волны будут экспоненциально нарастать во времени по мере их распространения вверх по цепочке автомобилей.
Этот расчет выполняется в функции `calculate_theoretical_lambda_max`.

## 7. Связь с кодом и практическая реализация

Скрипт `src/eidm_stability_analysis.py` реализует вышеописанные концепции:
*   **Модель IDM:** `calculate_idm_acceleration`, `calculate_s_hat`, `DEFAULT_IDM_PARAMS`.
*   **Равновесные состояния:** `find_equilibrium_velocity`, `calculate_s_star_for_fixed_v_star`, `find_all_equilibrium_states_for_flow`.
*   **Линейный анализ:** `calculate_partial_derivatives` для $ f_s, f_{\Delta v}, f_v $.
*   **Условия рационального вождения:** `check_rational_driving_constraints`.
*   **Устойчивость взвода:** `analyze_platoon_stability`.
*   **Устойчивость потока:** `analyze_string_stability` (на основе $ K $) и `calculate_theoretical_lambda_max` (на основе $ \max \text{Re}(\lambda(k)) $).
*   **Визуализация:** Функции `plot_stability_analysis` и `plot_stability_for_parameter_sweep` отображают фундаментальные диаграммы, значения производных, критерий $ K $ и области устойчивости в зависимости от параметров модели или равновесных состояний.
*   **Интеграция с SUMO:** Скрипт также включает функциональность для запуска симуляций в SUMO (`src/run_circle_simulation.py`) и анализа их результатов (`src/analyze_circle_data.py`) для валидации теоретических предсказаний устойчивости. Эта интеграция включает настройку и использование виртуальных детекторов для сбора данных о трафике и обнаружения волн.

### 7.1. Детектирование волн в симуляциях

Для анализа возникновения и распространения волн типа "stop-and-go" в симуляциях SUMO, были добавлены следующие элементы:

1.  **Размещение детекторов (E1)**:
    *   На кольцевой дороге размещаются индукционные петлевые детекторы (E1).
    *   Детекторы располагаются равномерно вдоль кольца (например, каждые `detector_spacing = 10` метров).
    *   Каждый детектор собирает данные за определенный период агрегации (`sampling_period_detector = Ts_detector`, например, 1 секунда).

2.  **Сбор данных с детекторов**:
    *   В ходе симуляции с шагом `Ts_detector` для каждого детектора $ i $ собираются:
        *   $ N_i[k] $: Количество транспортных средств (ТС), прошедших через детектор $ i $ за $ k $-ый интервал времени $ Ts_{detector} $.
        *   $ vbar_i[k] $: Средняя арифметическая скорость ТС, прошедших через детектор $ i $ за $ k $-ый интервал времени.
    *   Эти данные сохраняются в массивы $ N_data $ (количество ТС) и $ V_data $ (средняя скорость).

3.  **Расчет потока (Q) и плотности (rho)**:
    *   **Поток $ Q_i[k] $** для детектора $ i $ в интервале $ k $:
        $ Q_i[k] = N_i[k] / Ts_{detector} \quad [\text{ТС/сек}] $
        Перевод в ТС/час: $ Q_i[k] \cdot 3600 $.
    *   **Плотность $ \rho_i[k] $** для детектора $ i $ в интервале $ k $:
        $ \rho_i[k] = Q_i[k] / \text{vbar_i[k]} \quad [\text{ТС/м}] $
        (если $ \text{vbar_i[k]} > 0 $). Если $ \text{vbar_i[k]} = 0 $, а $ Q_i[k] > 0 $ (что маловероятно для агрегированных данных, но возможно если все ТС стояли прямо на детекторе), то плотность стремится к бесконечности. В реализации, если $ \text{vbar_i[k]} < \epsilon $, плотность можно считать очень высокой или использовать последний валидный $ \text{vbar} $, или рассчитывать через длину ТС. Чаще, если $ vbar_i[k] = 0 $ и $ N_i[k] > 0 $, это означает, что автомобили стоят. Плотность тогда лучше оценить по $ N_i[k] $ и длине детектора/зоны измерения, если это возможно, или использовать $ \rho_i[k] = N_i[k] / (\text{длина детектора}) $, если $ N_i[k] $ интерпретируется как число машин *на* детекторе в данный момент, а не прошедших. Но стандартная формула через поток и скорость: $ \rho = Q/v $. Если $ v \approx 0 $ и $ Q > 0 $ (машины медленно ползут), то $ \rho $ будет большим. Если $ v=0 $ и $ N=0 $, то $ Q=0, \rho=0 $.
        В нашей реализации: если `vbar_i[k]` близко к нулю, `rho_i[k]` устанавливается в большое значение или `NaN` для избежания деления на ноль, и такие точки могут требовать особой обработки при анализе.
    *   Данные сохраняются в $ Q_data $ и $ rho_data $.

4.  **Алгоритм `RealTimeWaveDetector` (используется в `traci_interaction.py`)**:
    *   **Цель**: Обнаруживать фронты волн уплотнения/разрежения в реальном времени по мере поступления данных с детекторов.
    *   **Вход**: `current_sim_time`, `detector_readings` (список кортежей `(id, N_i, vbar_i)` для каждого детектора).
    *   **Буферизация**: Хранит историю `V_data`, `N_data`, `Q_data`, `rho_data` для каждого детектора за последние `RT_HISTORY_SIZE` временных шагов.
    *   **Фильтрация**: Применяет скользящее среднее к сигналам скорости `V_data[i]` для каждого детектора `i` для сглаживания шумов.
    *   **Обнаружение между парами детекторов (i, i+1)**:
        1.  Берутся отфильтрованные сигналы скорости $ v_{filt, i}(t) $ и $ v_{filt, i+1}(t) $.
        2.  Вычисляется **взаимная корреляция** между этими двумя сигналами на небольшом временном окне.
        3.  Ищется пик в функции взаимной корреляции. Если значение пика превышает порог (`RT_CORR_THRESH`), это указывает на прохождение схожего паттерна скорости (т.е. волны) через два соседних детектора.
        4.  **Временной сдвиг (Lag)**: Положение пика корреляции дает временной сдвиг $ \Delta t_{wave} $ прохождения волны между детекторами.
        5.  **Скорость волны $ c_w $**:
            $ c_w = \Delta x / \Delta t_{wave} $
            где $ \Delta x = \text{coords}_{i+1} - \text{coords}_i $ - расстояние между детекторами. Скорость отрицательна для волн, распространяющихся против движения ТС (типично для stop-and-go).
        6.  **Время события**: Время, когда волна достигла "середины" между детекторами, или время у первого детектора. Например, $ t_{event} = t_{current} - \text{окно_корреляции}/2 + \text{lag_at_peak} $.
        7.  **Место события**: Координата середины между детекторами $ (coords_i + coords_{i+1}) / 2 $.
        8.  **Тип волны**: Определяется по знаку $ \Delta v $ перед и после прохождения волны (например, если скорость падает - фронт уплотнения). В текущей реализации это не детализировано, но может быть добавлено.
    *   **Компиляция событий**: Все обнаруженные события (время, место, скорость волны, сила корреляции) собираются в список.
    *   **Вывод**: Список событий сохраняется в `rt_detected_wave_events.csv` по окончании симуляции. Формат CSV: `event_time,event_position,wave_speed,correlation_strength,detector_pair_index`.

5.  **Функция `detect_stop_and_go_waves` (в `eidm_stability_analysis.py`)**:
    *   **Цель**: Пост-обработка данных с детекторов для более детального анализа волн и аннотации графиков.
    *   **Вход**: `cameras_coords`, `Ts_detector`, `V_data`, `N_data`, `Q_data` (опц.), `rho_data` (опц.).
    *   **Алгоритм**: Аналогичен `RealTimeWaveDetector`, но работает со всеми накопленными данными:
        *   Расчет Q и rho, если не переданы.
        *   Фильтрация сигналов скорости (например, фильтром Савицкого-Голея или скользящим средним).
        *   Взаимная корреляция между сигналами скорости от соседних камер (`V_data[i, :]` и `V_data[i+1, :]`).
        *   Определение временного лага, скорости волны, времени и места события.
        *   Фильтрация событий по силе корреляции и реалистичности скорости волны.
    *   **Выход**: Pandas DataFrame с информацией о каждой обнаруженной волне (время, позиция, скорость, направление и т.д.), который сохраняется в CSV файл.
    *   **Аннотация графиков**: Эта функция также может принимать оси Matplotlib для добавления маркеров или линий, указывающих обнаруженные волны на графиках $ v(x) $, $ v(t) $, $ \rho(x,t) $.

6.  **Использование в `analyze_circle_data.py`**:
    *   Загружаются данные с детекторов (`V_data`, `N_data`, `Q_data`, `rho_data`, `cameras_coords`, `Ts_detector`) и `rt_detected_wave_events.csv`.
    *   Вызывается `detect_stop_and_go_waves` для (повторного) анализа или просто для загрузки и использования уже детектированных `rt_detected_wave_events`.
    *   Времена событий из `rt_detected_wave_events.csv` (столбец `event_time`) используются для аннотации:
        *   На графике FCD "пространство-время" (`spacetime_heatmap_fcd.png`) проводятся вертикальные линии, соответствующие `event_time`. Это позволяет визуально сопоставить моменты, когда `RealTimeWaveDetector` зафиксировал прохождение волны, с фактической траекторией автомобилей.
        *   На графике плотности от времени для первого детектора (`density_vs_time_detector0.png`) также могут быть отмечены эти времена.

Этот подход позволяет как обнаруживать волны в реальном времени (для возможного управления потоком или немедленной диагностики), так и проводить их глубокий анализ после симуляции, связывая данные с детекторов с микроскопическими данными FCD. 