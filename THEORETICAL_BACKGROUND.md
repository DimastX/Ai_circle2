# Теоретическая база: Модели следования и анализ устойчивости

## 1. Введение

Модели следования за автомобилем (car-following models) описывают, как водители управляют своими транспортными средствами в зависимости от поведения впереди идущего автомобиля. Эти модели являются ключевым компонентом микроскопического моделирования транспортных потоков и используются для анализа пропускной способности дорог, возникновения заторов и оценки влияния различных стратегий управления движением. Линейный анализ устойчивости позволяет исследовать, как малые возмущения в транспортном потоке (например, резкое торможение одного автомобиля) распространяются и влияют на стабильность движения всей колонны автомобилей.

## 2. Интеллектуальная модель водителя (IDM)

Интеллектуальная модель водителя (IDM), предложенная Трейбером, Хеннеке и Хелбингом (2000), является популярной моделью следования, стремящейся реалистично описать поведение водителя.

### 2.1. Уравнение ускорения IDM

Ускорение $a_{IDM}$ транспортного средства в модели IDM определяется следующим уравнением (аналог Ур. 13 в статье-основе, но с учетом чистого зазора $s_{net}$):

$a_{IDM} = a \left[ 1 - \left( \frac{v}{v_0} \right)^{\delta} - \left( \frac{s^*(v, \Delta v)}{s_{net}} \right)^2 \right]$

где:
*   $a$ – максимальное ускорение.
*   $v$ – текущая скорость автомобиля.
*   $v_0$ – желаемая скорость (скорость на свободной дороге).
*   $\delta$ – показатель степени ускорения (обычно 4).
*   $s_{net}$ – чистый зазор (расстояние от переднего бампера текущего автомобиля до заднего бампера впереди идущего автомобиля). В оригинальной статье (Ур. 13) использовался $s-l$, где $s$ – межцентровое расстояние, $l$ – длина ТС. В коде используется напрямую $s_{net}$.
*   $s^*(v, \Delta v)$ – желаемое динамическое расстояние (чистый зазор).

### 2.2. Желаемое динамическое расстояние $s^*(v, \Delta v)$

Это расстояние, которое водитель стремится поддерживать. Оно зависит от текущей скорости $v$, разности скоростей с впереди идущим автомобилем $\Delta v = v_{leader} - v_{follower}$, и других параметров (аналог Ур. 14 в статье-основе):

$s^*(v, \Delta v) = s_0 + \max(0, vT + \frac{v \Delta v}{2 \sqrt{ab}})$

В коде используется несколько иная, но эквивалентная форма, полученная из $s_{hat}$ в статье, где член с $\Delta v$ вычитается:

$s^*(v, \Delta v) = s_0 + vT - \frac{v \Delta v}{2 \sqrt{ab}}$

(при условии, что $s_1=0$, как в статье и коде).
Желаемый чистый зазор не может быть отрицательным, поэтому в коде `calculate_s_hat` используется `max(0, s_hat_val)`.

### 2.3. Параметры IDM (используемые в `src/eidm_stability_analysis.py`)

*   `v0_desired_speed` ($v_0$): Желаемая скорость (м/с).
*   `T_safe_time_headway` ($T$): Желаемая безопасная временная дистанция (с).
*   `a_max_accel` ($a$): Максимальное комфортное ускорение (м/с²).
*   `b_comfort_decel` ($b$): Комфортное торможение (м/с²).
*   `delta_accel_exponent` ($\delta$): Показатель степени в члене ускорения (безразмерный).
*   `s0_jam_distance` ($s_0$): Минимальный чистый зазор в заторе (м).
*   `l_vehicle_length` ($l$): Длина транспортного средства (м). Используется для пересчета между чистым зазором ($s_{net}$) и полным межцентровым расстоянием ($s_{total} = s_{net} + l$).
*   `s1_gap_param` ($s_1$): Параметр дополнительного зазора, зависящий от скорости (м). В данном анализе и коде обычно принимается равным 0, согласно статье.

## 3. Равновесные состояния

Равновесное состояние в транспортном потоке характеризуется тем, что все автомобили движутся с постоянной скоростью и поддерживают постоянную дистанцию, а их ускорение равно нулю.

### 3.1. Нахождение равновесной скорости $v^*$ для заданной чистой дистанции $s^*_{net}$

Если задан равновесный чистый зазор $s^*_{net}$, то равновесная скорость $v^*$ находится путем решения уравнения $a_{IDM}(s^*_{net}, \Delta v = 0, v^*) = 0$.
Это реализуется в функции `find_equilibrium_velocity`.

### 3.2. Нахождение равновесной чистой дистанции $s^*_{net}$ для заданной скорости $v^*$

Если задана равновесная скорость $v^*$, то соответствующий ей равновесный чистый зазор $s^*_{net}$ находится также из условия $a_{IDM}(s^*_{net}, \Delta v = 0, v^*) = 0$.
Это реализуется в функции `calculate_s_star_for_fixed_v_star`.

### 3.3. Нахождение равновесных состояний ($v_e, s_{e,net}$) для заданного потока $Q$

Поток $Q$ (автомобилей/сек) связан со скоростью $v_e$ (м/с) и полным равновесным межцентровым расстоянием $s_{e,total}$ (м) как $Q = v_e / s_{e,total}$.
Так как $s_{e,total} = s_{e,net} + l$, то $s_{e,net} = v_e/Q - l$.
Равновесные состояния ($v_e, s_{e,net}$) для заданного потока $Q$ находятся решением системы:
1.  $a_{IDM}(s_{e,net}, 0, v_e) = 0$
2.  $s_{e,net} = v_e/Q - l$
Это реализуется в функциях `find_equilibrium_state_for_flow` и `find_all_equilibrium_states_for_flow`. Для одного значения $Q$ может существовать несколько равновесных состояний (например, свободный поток и плотный поток).

## 4. Линейный анализ устойчивости

Линейный анализ устойчивости исследует поведение системы в ответ на малые возмущения от состояния равновесия. Уравнение движения (Ур. 2 в статье) линеаризуется:
$\dot{v}_n = f(s_n, \Delta v_n, v_n)$

### 4.1. Малые возмущения

Рассматриваются малые отклонения от равновесного состояния $(s^*, 0, v^*)$:
$s_n(t) = s^* + \tilde{s}_n(t)$
$v_n(t) = v^* + \tilde{v}_n(t)$
$\Delta v_n(t) = 0 + \Delta \tilde{v}_n(t) = \dot{\tilde{s}}_n(t)$

### 4.2. Линеаризованное уравнение

После линеаризации уравнение ускорения (Ур. 7 в статье) принимает вид:
$\dot{\tilde{v}}_n = f_s \tilde{s}_n + f_{\Delta v} \dot{\tilde{s}}_n + f_v \tilde{v}_n$

где $f_s, f_{\Delta v}, f_v$ – частные производные функции $f$ по $s$, $\Delta v$ и $v$ соответственно, вычисленные в точке равновесия $(s^*, 0, v^*)$.
*   $f_s = \frac{\partial f}{\partial s}$: Чувствительность ускорения к изменению дистанции.
*   $f_{\Delta v} = \frac{\partial f}{\partial \Delta v}$: Чувствительность ускорения к изменению относительной скорости.
*   $f_v = \frac{\partial f}{\partial v}$: Чувствительность ускорения к изменению собственной скорости.

Эти производные вычисляются в функции `calculate_partial_derivatives`. В коде $s^*$ соответствует $s^*_{net}$.

### 4.3. Условия рационального вождения

Для того чтобы модель поведения водителя была физически осмысленной, ее частные производные в точке равновесия должны удовлетворять "условиям рационального вождения" (Ур. 10 в статье):
*   $f_s > 0$: Увеличение дистанции должно приводить к увеличению ускорения (или уменьшению замедления).
*   $f_{\Delta v} \ge 0$: Увеличение относительной скорости (т.е. если лидер удаляется быстрее или текущий автомобиль приближается медленнее) должно приводить к увеличению ускорения. В статье указано $f_{\Delta v} > 0$, но в коде `check_rational_driving_constraints` используется $f_{\Delta v} \ge -1e-9$.
*   $f_v < 0$: Увеличение собственной скорости должно приводить к уменьшению ускорения (или увеличению замедления).

Эти условия проверяются в `check_rational_driving_constraints`.

## 5. Устойчивость взвода (Platoon Stability / Local Stability)

Устойчивость взвода описывает, затухнут ли со временем флуктуации в *конечном* взводе автомобилей после некоторого начального возмущения, при условии, что ведущий автомобиль движется с постоянной скоростью.
Характеристическое уравнение для анализа устойчивости взвода (Ур. 16 в статье):
$\lambda_{plat}^2 + (f_{\Delta v} - f_v) \lambda_{plat} + f_s = 0$

Взвод считается устойчивым, если действительные части обоих корней $\lambda_{plat}$ отрицательны. Согласно критериям Рауса-Гурвица, это эквивалентно следующим условиям (при условии, что коэффициенты положительны):
1.  $f_{\Delta v} - f_v > 0$
2.  $f_s > 0$

Анализ проводится в функции `analyze_platoon_stability`. Если условия рационального вождения выполнены, то $f_s > 0$ и $-f_v > 0$. Если также $f_{\Delta v} \ge 0$, то $f_{\Delta v} - f_v > 0$, и взвод устойчив.

## 6. Устойчивость потока/цепочки (String Stability / Asymptotic Stability)

Устойчивость потока (или струнная устойчивость) характеризует, как возмущения распространяются вверх по *бесконечной* цепочке автомобилей. Поток считается устойчивым, если амплитуда возмущений затухает при распространении от автомобиля к автомобилю вверх по течению. Если амплитуда нарастает, поток неустойчив, что может приводить к образованию спонтанных заторов ("stop-and-go waves").

### 6.1. Критерий на основе $\lambda_2$ (или K в коде)

Один из подходов к анализу (Ур. 20 в статье) заключается в исследовании знака коэффициента $\lambda_2$ в разложении частоты возмущения $\lambda(\theta)$ по волновому числу $\theta$ для малых $\theta$ (длинноволновые возмущения):
$\lambda_2 = \frac{f_s}{f_v^3} \left( \frac{f_v^2}{2} - f_{\Delta v} f_v - f_s \right)$

При выполнении условий рационального вождения ($f_s > 0, f_v < 0$), имеем $f_s/f_v^3 < 0$.
Следовательно, для устойчивости потока ($\lambda_2 < 0$) необходимо, чтобы выражение в скобках было положительным:
$K = \frac{f_v^2}{2} - f_{\Delta v} f_v - f_s > 0$

Этот критерий $K$ используется в функции `analyze_string_stability`.

### 6.2. Общий анализ через $\lambda(k)$

Более общий метод анализа устойчивости потока заключается в нахождении собственных значений (инкрементов) $\lambda$ характеристического уравнения линеаризованной системы для различных волновых чисел $k$ (или $\theta$ в статье, где $\theta = k \cdot s_{total}^*$). Характеристическое уравнение для $\lambda(k)$ (аналог Ур. 18 в статье, но с использованием $s_{total}^*$):
$\lambda^2 + \lambda [f_{\Delta v} - f_v - f_{\Delta v} e^{-i k s_{total}^* }] + [f_s (1 - e^{-i k s_{total}^* })] = 0$

Поток считается асимптотически (струнно) устойчивым, если максимальная действительная часть $\text{Re}(\lambda(k))$ отрицательна для всех $k \in (0, \pi/s_{total}^*]$. Если $\max_k (\text{Re}(\lambda(k))) > 0$, поток неустойчив.
Этот расчет выполняется в функции `calculate_theoretical_lambda_max`.

## 7. Связь с кодом `src/eidm_stability_analysis.py`

Скрипт `src/eidm_stability_analysis.py` реализует вышеописанные концепции:
*   **Модель IDM:** `calculate_idm_acceleration`, `calculate_s_hat`, `DEFAULT_IDM_PARAMS`.
*   **Равновесные состояния:** `find_equilibrium_velocity`, `calculate_s_star_for_fixed_v_star`, `find_all_equilibrium_states_for_flow`.
*   **Линейный анализ:** `calculate_partial_derivatives` для $f_s, f_{\Delta v}, f_v$.
*   **Условия рационального вождения:** `check_rational_driving_constraints`.
*   **Устойчивость взвода:** `analyze_platoon_stability`.
*   **Устойчивость потока:** `analyze_string_stability` (на основе $K$) и `calculate_theoretical_lambda_max` (на основе $\max \text{Re}(\lambda(k))$).
*   **Визуализация:** Функции `plot_stability_analysis` и `plot_stability_for_parameter_sweep` отображают фундаментальные диаграммы, значения производных, критерий $K$ и области устойчивости в зависимости от параметров модели или равновесных состояний.
*   **Интеграция с SUMO:** Скрипт также включает функциональность для запуска симуляций в SUMO (`run_circle_simulation.py`) и анализа их результатов (`analyze_circle_data.py`) для валидации теоретических предсказаний устойчивости. 