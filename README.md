# AI Circle Simulation

Проект для моделирования движения транспортных средств по круговой дороге с использованием SUMO (Simulation of Urban MObility) и EIDM (Enhanced Intelligent Driver Model). Проект включает в себя различные сценарии моделирования, включая анализ пробок и теорию пробок.

## Структура проекта

```
.
├── config/
│   ├── network/     # Файлы сети (circle.net.xml, circle.nod.xml, circle.edg.xml)
│   └── routes/      # Файлы маршрутов (генерируются автоматически)
├── data/
│   └── simulations/ # Результаты симуляций
├── results/
│   └── analysis/    # Результаты анализа данных
├── ring_files/      # Файлы для кольцевой дороги
├── src/
│   ├── generate_circle_rou_new.py  # Генератор маршрутов
│   ├── run_circle.py              # Скрипт запуска симуляции
│   ├── analyze_data.py           # Скрипт анализа данных
│   ├── new_breakdown.py          # Моделирование пробок (базовая версия)
│   ├── new_breakdown_N.py        # Моделирование пробок (расширенная версия)
│   ├── theory_breakdown.py       # Теоретический анализ пробок
│   └── circle_gen.py             # Генератор кольцевой дороги
└── requirements.txt # Зависимости проекта
```

## Установка

1. Установите SUMO (Simulation of Urban MObility):
   - Windows: Скачайте и установите с [официального сайта](https://sumo.dlr.de/docs/Installing/Windows.html)
   - Linux: `sudo apt-get install sumo`

2. Установите зависимости проекта:
   ```bash
   pip install -r requirements.txt
   ```

## Использование

### Базовое моделирование
1. Генерация маршрутов:
   ```bash
   cd src
   python generate_circle_rou_new.py
   ```

2. Запуск симуляции:
   ```bash
   cd src
   python run_circle.py
   ```

### Моделирование пробок
1. Базовая версия:
   ```bash
   cd src
   python new_breakdown.py
   ```

2. Расширенная версия:
   ```bash
   cd src
   python new_breakdown_N.py
   ```

### Теоретический анализ
```bash
cd src
python theory_breakdown.py
```

### Анализ данных
```bash
cd src
python analyze_data.py --file путь/к/файлу/с/данными.csv
```

## Параметры симуляции

### Базовые параметры
- Количество машин на каждом маршруте: 7
- Длина ребра: 87.15 метров
- Параметры EIDM:
  - Ускорение: 2.6 ± 0.5 м/с²
  - Замедление: 4.5 ± 0.5 м/с²
  - Сигма: 0.5 ± 0.1
  - Тау: 0.5 ± 0.1
  - Дельта: 0.5 ± 0.1
  - Степпинг: 0.5 ± 0.1

### Параметры моделирования пробок
- Время начала торможения: 10 секунд
- Длительность торможения: настраивается
- Количество автомобилей: настраивается
- Параметры EIDM могут быть модифицированы для различных сценариев

## Результаты

### Результаты симуляции
Результаты симуляции сохраняются в директории `data/simulations/` в формате CSV. 

### Результаты анализа
После завершения симуляции автоматически создаются следующие графики в директории `results/analysis/`:
- `velocity_time.png` - график скорости от времени V(t)
- `distance_time.png` - график пройденного расстояния от времени S(t)

На графиках:
- Красной линией выделен тормозящий автомобиль
- Синим цветом показаны остальные автомобили
- Вертикальной пунктирной линией отмечен момент торможения (10с) 

## Анализ устойчивости и сравнение с SUMO (eidm_stability_analysis.py)

Скрипт `src/eidm_stability_analysis.py` предназначен для проведения теоретического анализа устойчивости транспортного потока, описываемого моделью IDM (Intelligent Driver Model), и опционального сравнения теоретических предсказаний с результатами симуляций в SUMO для кольцевой дороги.

### Запуск

```bash
# Только теоретический анализ
python src/eidm_stability_analysis.py

# Теоретический анализ + запуск симуляций SUMO для сравнения
python src/eidm_stability_analysis.py --run-sumo-simulations --sumo-binary /path/to/sumo-gui.exe --sumo-tools-dir /path/to/sumo/tools
```

### Функционал

1.  **Теоретический анализ:**
    *   Находит равновесные состояния (скорость `v_e`, чистый зазор `s_e_net`) для различных условий (например, для заданного потока `Q`).
    *   Вычисляет частные производные IDM (`f_s`, `f_dv`, `f_v`) в точках равновесия.
    *   Определяет устойчивость взвода (platoon stability).
    *   Определяет устойчивость потока (string stability) с помощью критерия `K = f_v²/2 - f_dv*f_v - f_s`.
    *   Генерирует графики, иллюстрирующие:
        *   Фундаментальную диаграмму (v* от s*_net).
        *   Зависимость производных и критерия K от скорости.
        *   Области устойчивости взвода и потока.
        *   Влияние параметров IDM (например, времени реакции `T`) на устойчивость при фиксированных условиях (например, потоке `Q`).

2.  **Интеграция с SUMO (при флаге `--run-sumo-simulations`):**
    *   Для выбранного сценария (например, варьирование `T` при фиксированном `Q`):
        *   Для каждого теоретического равновесного состояния (`v_e`, `s_e_net`) рассчитывает необходимое количество машин `N` для кольца фиксированной длины.
        *   **Вызывает `src/run_circle_simulation.py`:** Запускает симуляцию SUMO для кольца с рассчитанным количеством машин `N`. Этот скрипт подготавливает конфигурационные файлы SUMO (модифицируя `.rou.xml` и `.sumocfg`), запускает симуляцию и конвертирует результаты (FCD) в CSV.
        *   **Вызывает `src/analyze_circle_data.py`:** Анализирует полученный CSV файл. Этот скрипт вычисляет метрики (например, стандартное отклонение скорости для детекции волн), строит графики (V(t), S(t), V(x), x-t тепловую карту, FFT) и сохраняет сводку анализа (включая флаг `waves_observed`) в `analysis_summary.json`.
        *   **Считывает `analysis_summary.json`:** Извлекает результат симуляции (`waves_observed`).
    *   **Сравнение:** Перерисовывает теоретический график устойчивости (например, T vs Устойчивость потока), добавляя на него точки, полученные из симуляций SUMO, помеченные как стабильные или нестабильные. 
