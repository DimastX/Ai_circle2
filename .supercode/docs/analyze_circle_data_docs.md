# Документация по `src/analyze_circle_data.py`

## Общее описание

Этот скрипт отвечает за анализ данных, полученных в результате симуляций SUMO, запущенных через `run_circle_simulation.py`. Его основная задача - обработать сырые данные (FCD и данные детекторов), визуализировать их и извлечь ключевые метрики, в частности, информацию о наличии или отсутствии stop-and-go волн.

Основные задачи:

1.  **Загрузка и предварительная обработка данных**:
    *   Загружает FCD (Floating Car Data - траектории ТС) из CSV файла.
    *   Загружает агрегированные данные с детекторов E1 из CSV файла (`detector_data.csv`).
    *   Загружает данные о событиях волн, обнаруженных в реальном времени детектором `RealTimeWaveDetector` (из `rt_detected_wave_events.csv`), если они есть.
    *   Переименовывает колонки для единообразия.
    *   Применяет фильтр `warmup_time` для отсечения начального периода симуляции из FCD данных.
2.  **Расчет характеристик потока**:
    *   На основе данных детекторов рассчитывает усредненные по времени и пространству характеристики: скорость, поток, плотность.
    *   Рассчитывает стандартное отклонение скорости как метрику нестабильности.
3.  **Визуализация данных**:
    *   Строит пространственно-временные диаграммы (тепловые карты) скорости.
    *   Строит графики V(t), Q(t), Rho(t) для отдельных детекторов или усредненные.
    *   Строит графики V(x) (профиль скорости по кольцу) для разных моментов времени.
    *   Строит фундаментальные диаграммы Q(Rho).
    *   Производит FFT анализ сигналов скорости (опционально, если функция `plot_fft_analysis` не закомментирована).
    *   Аннотирует графики информацией об обнаруженных волнах (из `rt_detected_wave_events.csv` и/или с помощью собственной функции `detect_stop_and_go_waves`).
4.  **Обнаружение Stop-and-Go волн** (если не используется только `rt_detected_wave_events.csv`):
    *   Содержит функцию `detect_stop_and_go_waves` (похожую на ту, что есть в `eidm_stability_analysis.py`), которая анализирует данные с детекторов для обнаружения волн на основе взаимной корреляции сигналов скорости от соседних детекторов.
    *   Сохраняет обнаруженные события в `stop_and_go_events.csv` (если эта функция активна).
5.  **Сохранение результатов анализа**:
    *   Все сгенерированные графики сохраняются в поддиректорию `analysis_{timestamp}` внутри директории результатов симуляции.
    *   Ключевые метрики и параметры анализа сохраняются в `analysis_summary.json`. Этот файл включает:
        *   `waves_observed` (bool): Флаг, указывающий, были ли обнаружены волны.
        *   `mean_speed_std_dev`: Стандартное отклонение средней скорости.
        *   `lambda_exp`: Экспериментально наблюдаемый инкремент возмущений (если рассчитывается).
        *   Параметры запуска анализа.

## Ключевые функции и их назначение

-   **`plot_spacetime_heatmap`**: Строит тепловую карту V(x,t).
-   **`plot_fft_analysis`**: Выполняет и строит результаты FFT анализа (может быть неактивна).
-   **`save_analysis_summary`**: Сохраняет `analysis_summary.json`.
-   **`analyze_circle_data`**: Основная функция, управляющая загрузкой, обработкой, анализом и визуализацией данных.
-   **`detect_stop_and_go_waves`**: Функция для обнаружения волн (см. замечание в разделе "Замечания").
-   **`main`**: Парсит аргументы командной строки и вызывает `analyze_circle_data`.

## Внешние зависимости (ключевые импорты)

-   **Стандартные библиотеки Python**:
    *   `os`
    *   `argparse`
    *   `json`
    *   `csv`
    *   `datetime`
    *   `logging`
-   **Сторонние библиотеки (из `requirements.txt`)**:
    *   `pandas`
    *   `numpy`
    *   `matplotlib`
    *   `scipy` (для `scipy.signal.correlate`, `scipy.signal.find_peaks`, `scipy.fft`)
-   **Внутренние модули проекта**:
    *   (Ранее) Мог импортировать `detect_stop_and_go_waves` из `eidm_stability_analysis`. Текущая версия файла `eidm_stability_analysis.py` содержит эту функцию, и `analyze_circle_data.py` также содержит свою версию этой функции. Это дублирование.

## Взаимодействие с другими компонентами

-   Вызывается скриптом `src/eidm_stability_analysis.py` после каждой завершенной симуляции SUMO.
-   Читает выходные файлы, созданные `src/run_circle_simulation.py` (например, `fcd_output.csv`, `detector_data.csv`, `rt_detected_wave_events.csv`).
-   Результат его работы (в частности, `analysis_summary.json`) используется `src/eidm_stability_analysis.py` для обновления теоретических графиков устойчивости.

## Основной сценарий вызова (из `eidm_stability_analysis.py`)

```bash
python src/analyze_circle_data.py --results-dir /path/to/simulation/output --length RING_LENGTH
```
-   `--results-dir`: Путь к директории, содержащей выходные файлы одной конкретной симуляции, созданной `run_circle_simulation.py`.
-   `--length`: Длина кольцевой трассы (L), необходима для корректных расчетов и визуализаций.
-   `--warmup-time`: Время прогрева симуляции (секунды), данные до этого момента отбрасываются из FCD.

## Ключевые структуры данных и файлы

-   **Входные файлы (из директории `--results-dir`)**:
    *   `fcd_output_*.csv` (траектории ТС)
    *   `detector_data.csv` (данные детекторов E1)
    *   `rt_detected_wave_events.csv` (опционально, волны от `RealTimeWaveDetector`)
    *   `simulation_params.json` (параметры запуска симуляции, для информации)
-   **Выходные файлы (в поддиректории `analysis_{timestamp}` внутри `--results-dir`)**:
    *   Множество `.png` файлов с графиками.
    *   `analysis_summary.json` (ключевые метрики анализа).
    *   `stop_and_go_events.csv` (если используется внутренняя функция `detect_stop_and_go_waves`).

## Конфигурация и параметры командной строки

-   `--results-dir`: Обязательный. Директория с результатами одной симуляции.
-   `--length` (`-L`): Обязательный. Длина кольца в метрах.
-   `--warmup-time`: Опциональный. Время прогрева для отбрасывания из FCD (по умолчанию 0.0).
-   `--config-path`: Опциональный. Путь к файлу `simulation_params.json` (обычно находится автоматически).

## Замечания и возможные улучшения

-   **Дублирование `detect_stop_and_go_waves`**: Эта функция присутствует и в `eidm_stability_analysis.py`, и в `analyze_circle_data.py`. Необходимо унифицировать и оставить только одну версию, либо четко разделить их назначение. Предпочтительно, чтобы анализ данных симуляции (включая обнаружение волн по данным детекторов) полностью выполнялся в `analyze_circle_data.py`.
-   Алгоритм `detect_stop_and_go_waves` чувствителен к параметрам (`CORR_THRESH`, `MOVING_AVG_WINDOW` и т.д.). Эти параметры могут потребовать калибровки.
-   Расчет `lambda_exp` (экспериментального инкремента) может быть не всегда активен или надежен. 