# Документация по `src/eidm_stability_analysis.py`

## Общее описание

Этот скрипт является центральным для анализа линейной устойчивости Интеллектуальной Модели Водителя (IDM) и расширенной IDM (EIDM). Он выполняет следующие основные задачи:

1.  **Теоретический анализ IDM/EIDM**:
    *   Расчет параметров IDM и равновесных состояний (скорость, дистанция, поток).
    *   Вычисление частных производных функции ускорения IDM ($f_s, f_{\Delta v}, f_v$) в точках равновесия.
    *   Анализ устойчивости взвода (platoon stability / local stability) на основе критериев Рауса-Гурвица.
    *   Анализ устойчивости потока/цепочки (string stability / asymptotic stability) двумя методами:
        *   С использованием критерия K.
        *   Путем численного нахождения максимальной действительной части собственных значений $\lambda(k)$ характеристического уравнения.
2.  **Построение графиков**:
    *   Фундаментальные диаграммы.
    *   Значения производных и критерия K.
    *   Области устойчивости в зависимости от параметров модели или равновесных состояний.
    *   Графики параметрического анализа влияния отдельных параметров IDM на устойчивость.
3.  **Запуск симуляций SUMO** (опционально):
    *   При указании флага `--run-sumo-simulations` скрипт вызывает `run_circle_simulation.py` для проведения симуляций на кольцевой трассе.
    *   Это делается для набора параметров (например, варьируя время реакции `T` при фиксированном потоке `Q`) для валидации теоретических предсказаний.
4.  **Анализ результатов симуляций SUMO** (опционально):
    *   После каждой симуляции вызывает `analyze_circle_data.py` для обработки FCD данных и данных с детекторов.
    *   Собирает информацию о наличии или отсутствии stop-and-go волн.
    *   Добавляет экспериментальные точки на теоретические графики устойчивости.
5.  **Интеграция с VSL** (опционально):
    *   При указании флага `--vsl` (вместе с `--run-sumo-simulations`) активирует управление переменными скоростными ограничениями в симуляциях SUMO, вызывая `vsl_controller.py` через `run_circle_simulation.py`.

## Ключевые функции и их назначение

-   **`calculate_idm_acceleration`**: Расчет ускорения по модели IDM.
-   **`find_equilibrium_velocity`**: Поиск равновесной скорости по чистому зазору.
-   **`calculate_s_star_for_fixed_v_star`**: Поиск равновесного чистого зазора по скорости.
-   **`find_all_equilibrium_states_for_flow`**: Поиск всех равновесных состояний (v, s_net) для потока Q.
-   **`calculate_partial_derivatives`**: Расчет производных $f_s, f_{\Delta v}, f_v$.
-   **`check_rational_driving_constraints`**: Проверка выполнения условий рационального вождения.
-   **`analyze_platoon_stability`**: Анализ устойчивости взвода.
-   **`analyze_string_stability`**: Анализ устойчивости потока по критерию K.
-   **`calculate_theoretical_lambda_max`**: Анализ устойчивости потока по $\max Re(\lambda(k))$.
-   **`collect_data_for_plots`**: Сбор данных для графиков зависимости от $s^*_{net}$.
-   **`plot_stability_analysis`**: Построение этих графиков.
-   **`collect_data_for_param_sweep`**: Сбор данных для параметрического анализа.
-   **`plot_stability_for_parameter_sweep`**: Построение графиков параметрического анализа.
-   **`detect_stop_and_go_waves`**: Анализирует данные с симулированных детекторов для обнаружения stop-and-go волн. (Примечание: эта функция также присутствует в `analyze_circle_data.py`, следует уточнить, какая версия используется или планируется к использованию).
-   **`compute_rho_crit`**: Вычисляет критическую плотность для VSL.
-   **`main`**: Главная функция, управление выполнением, парсинг аргументов командной строки, оркестрация теоретического анализа, запуска симуляций и анализа результатов.

## Внешние зависимости (ключевые импорты)

-   **Стандартные библиотеки Python**:
    *   `math`, `cmath`
    *   `argparse`
    *   `os`
    *   `subprocess`
    *   `datetime`
    *   `json`
    *   `csv`
    *   `logging`
-   **Сторонние библиотеки (из `requirements.txt`)**:
    *   `numpy`
    *   `matplotlib`
    *   `scipy` (особенно `scipy.optimize.brentq`, `scipy.signal.correlate`, `scipy.signal.find_peaks`)
    *   `pandas`
-   **Внутренние модули проекта**:
    *   `src.run_circle_simulation` (через `subprocess.run`)
    *   `src.analyze_circle_data` (через `subprocess.run`)

## Взаимодействие с другими компонентами

-   Вызывает `src/run_circle_simulation.py` для запуска симуляций SUMO.
-   Вызывает `src/analyze_circle_data.py` для анализа результатов симуляций.
-   Теоретические расчеты и построение графиков производятся внутри этого скрипта.

## Основные сценарии использования (в контексте этого файла)

1.  **Полный анализ с симуляциями (без VSL)**:
    ```bash
    python src/eidm_stability_analysis.py --run-sumo-simulations
    ```
    В этом сценарии `main()` выполняет теоретический анализ, затем для выбранных точек равновесия запускает `run_circle_simulation.py`, и после каждой симуляции вызывает `analyze_circle_data.py`. Результаты симуляций используются для аннотирования теоретических графиков.

2.  **Полный анализ с симуляциями и VSL**:
    ```bash
    python src/eidm_stability_analysis.py --run-sumo-simulations --vsl
    ```
    Аналогично предыдущему, но при вызове `run_circle_simulation.py` передаются параметры для активации VSL-контроллера.

3.  **Только теоретический анализ (без запуска SUMO)**:
    Если флаг `--run-sumo-simulations` не указан, скрипт выполнит только теоретические расчеты и построит графики без экспериментальных данных.

## Ключевые структуры данных

-   **`DEFAULT_IDM_PARAMS` (dict)**: Словарь со стандартными параметрами модели IDM.
-   **`DEFAULT_VSL_PARAMS` (dict)**: Словарь со стандартными параметрами VSL-контроллера (используется при передаче в `run_circle_simulation.py`).
-   Результаты функций `collect_data_for_plots` и `collect_data_for_param_sweep` представляют собой словари с `numpy` массивами, содержащими данные для построения графиков (значения параметров, равновесные состояния, производные, флаги устойчивости).

## Конфигурация и параметры командной строки

-   `--sumo-binary`: Путь к `sumo-gui.exe` или `sumo.exe`.
-   `--sumo-tools-dir`: Путь к директории `tools` в SUMO.
-   `--run-sumo-simulations`: Флаг для запуска симуляций SUMO.
-   `--vsl`: Флаг для активации VSL в симуляциях SUMO.

## Замечания и возможные улучшения

-   Функция `detect_stop_and_go_waves` присутствует и в этом файле, и в `analyze_circle_data.py`. Необходимо убедиться в консистентности или удалить дублирование.
-   Передача параметров IDM в `run_circle_simulation.py` при запусках из `eidm_stability_analysis.py` могла бы быть реализована через аргумент командной строки (например, JSON-строку), чтобы `run_circle_simulation.py` не зависел от параметров, захардкоженных или определенных в `eidm_stability_analysis.py` (касается обновления `T_safe_time_headway` для каждой итерации параметрического анализа). 