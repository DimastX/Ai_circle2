# Документация по `src/traci_interaction.py`

## Общее описание

Этот модуль инкапсулирует низкоуровневое взаимодействие с симулятором SUMO через интерфейс TraCI (Traffic Control Interface). Он предоставляет функции для управления симуляцией, сбора данных с детекторов, а также включает класс `RealTimeWaveDetector` для обнаружения stop-and-go волн в реальном времени в ходе симуляции.

Основные компоненты и задачи:

1.  **Управление симуляцией SUMO**:
    *   `connect_sumo`: Устанавливает соединение с SUMO, запуская симулятор, если необходимо.
    *   `simulation_step`: Выполняет один или несколько шагов симуляции.
    *   `close_sumo`: Закрывает соединение с SUMO и завершает работу симулятора.
2.  **Сбор данных с детекторов**:
    *   `get_detector_data`: Получает данные (количество ТС, средняя скорость, загруженность, плотность) с указанных детекторов E1 (loop detectors) за последний период симуляции.
3.  **Обнаружение волн в реальном времени (`RealTimeWaveDetector`)**:
    *   **Класс `RealTimeWaveDetector`**:
        *   Инициализируется с идентификаторами детекторов, их координатами, периодом дискретизации и параметрами алгоритма обнаружения.
        *   Хранит буфер данных о скорости с детекторов за определенное время (`buffer_size_seconds`).
        *   **`update_and_detect`**: Метод, вызываемый на каждом шаге симуляции. Обновляет буфер новыми данными с детекторов и запускает алгоритм обнаружения волн.
        *   **Алгоритм обнаружения волн**:
            *   Сглаживает сигналы скорости с помощью скользящего среднего.
            *   Вычисляет взаимную корреляцию между сигналами скорости от пар соседних детекторов.
            *   Ищет пики корреляции, превышающие порог (`CORR_THRESH`).
            *   Если пик найден, рассчитывает скорость волны и определяет момент и место начала волны на основе резкого падения скорости на первой камере в паре.
            *   Реализует механизм "cooldown" для предотвращения многократного срабатывания на одно и то же событие.
        *   **`get_detected_event_details`**: Возвращает детали последнего обнаруженного события.
        *   Сохраняет свою конфигурацию (`rt_config.json`) и список всех обнаруженных событий (`rt_detected_wave_events.csv`) при вызове метода сохранения в `run_circle_simulation.py`.

## Ключевые функции и классы

-   **`connect_sumo(sumo_cmd_list, port=None)`**: Запускает SUMO как подпроцесс и устанавливает TraCI соединение.
-   **`simulation_step(time_step_ms=None)`**: Продвигает симуляцию на один шаг (или на указанное время).
-   **`get_detector_data(detector_ids)`**: Возвращает словарь с данными от указанных детекторов.
-   **`close_sumo()`**: Закрывает TraCI соединение.
-   **`class RealTimeWaveDetector`**:
    *   `__init__(...)`: Конструктор, принимает параметры детектора и алгоритма.
    *   `update_and_detect(current_sim_time_s, new_readings_dict)`: Основной метод для обновления состояния и запуска обнаружения.
    *   `get_detected_event_details()`: Возвращает информацию о последней обнаруженной волне.

## Внешние зависимости (ключевые импорты)

-   **Стандартные библиотеки Python**:
    *   `os`
    *   `sys`
    *   `subprocess`
    *   `time`
    *   `json`
    *   `csv`
    *   `collections.deque`
    *   `math`
    *   `logging`
-   **Сторонние библиотеки (из `requirements.txt`)**:
    *   `numpy`
    *   `pandas`
    *   `scipy.signal` (для `correlate`, `find_peaks` в `RealTimeWaveDetector`)
-   **SUMO (TraCI)**:
    *   `traci`
    *   `traci.constants`

## Взаимодействие с другими компонентами

-   Этот модуль используется в `src/run_circle_simulation.py` для:
    *   Управления жизненным циклом симуляции SUMO.
    *   Получения данных с детекторов на каждом шаге симуляции.
    *   Обновления и использования экземпляра `RealTimeWaveDetector`.
-   `VSLController` из `src/vsl_controller.py` также использует функции этого модуля (или напрямую `traci`) для получения данных и применения управляющих воздействий.

## Основной сценарий использования

Экземпляр `RealTimeWaveDetector` создается в `run_circle_simulation.py`. На каждом шаге симуляции `run_circle_simulation.py` вызывает `get_detector_data` для получения свежих данных, а затем передает их в метод `update_and_detect` экземпляра `RealTimeWaveDetector`. Если детектор обнаруживает волну, `run_circle_simulation.py` может получить информацию об этом событии.

## Ключевые структуры данных

-   **`RealTimeWaveDetector`**:
    *   `self.speed_buffer` (dict of deques): Хранит временные ряды скоростей для каждого детектора.
    *   `self.time_buffer` (dict of deques): Хранит временные метки для данных в `speed_buffer`.
    *   `self.detected_events` (list of dicts): Список всех обнаруженных событий волн.
    *   `self.last_event_time_on_pair` (dict): Для механизма cooldown.
-   Данные, возвращаемые `get_detector_data`, представляют собой словарь, где ключи - ID детекторов, а значения - словари с метриками (`meanSpeed`, `vehicleCount`, `occupancy`, `density`, `flowRate`).

## Конфигурация и параметры

-   Параметры `RealTimeWaveDetector` (такие как `RT_BUFFER_SIZE_SECONDS`, `RT_MOVING_AVG_WINDOW`, `RT_CORR_THRESH` и т.д.) задаются как константы в начале файла `traci_interaction.py` или передаются в конструктор класса при его создании в `run_circle_simulation.py`.

## Замечания и возможные улучшения

-   Алгоритм `RealTimeWaveDetector` основан на тех же принципах, что и `detect_stop_and_go_waves` в других модулях, но адаптирован для работы в реальном времени (пошагово). Это может приводить к некоторым различиям в обнаружении по сравнению с оффлайн-анализом всех данных сразу.
-   Чувствительность и точность `RealTimeWaveDetector` сильно зависят от его параметров.
-   Модуль предполагает, что переменная окружения `SUMO_HOME` установлена для корректного импорта `traci`. 